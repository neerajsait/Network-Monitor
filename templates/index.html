<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NETWATCH // OPS CENTER 2025</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg: #050505;
            --panel: rgba(0, 12, 0, 0.95);
            --neon: #00ff41;
            --dim: #003311;
            --alert: #ff3333;
            --warn: #ffcc00;
            --border: 1px solid var(--dim);
        }

        * { box-sizing: border-box; }
        body {
            margin: 0; padding: 0; height: 100vh; overflow: hidden;
            background: var(--bg);
            color: var(--neon);
            font-family: 'Share Tech Mono', monospace;
            background-image: 
                linear-gradient(rgba(0,50,0,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,50,0,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .grid-container {
            display: grid;
            grid-template-columns: 310px 1fr 360px;
            grid-template-rows: 60px 1fr 260px;
            gap: 8px;
            padding: 8px;
            height: 100vh;
        }

        .panel {
            background: var(--panel);
            border: var(--border);
            box-shadow: 0 0 15px rgba(0,0,0,0.8);
            backdrop-filter: blur(6px);
            overflow: hidden;
            border-radius: 4px;
        }

        .panel-head {
            background: var(--dim);
            padding: 8px 12px;
            font-size: 0.9rem;
            border-bottom: var(--border);
            text-shadow: 0 0 8px var(--neon);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header {
            grid-column: 1 / -1;
            background: #000;
            border-bottom: 2px solid var(--neon);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 1.1rem;
        }

        .brand { font-size: 1.6rem; letter-spacing: 3px; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        #map { height: 280px; width: 100%; background: #000; }
        .leaflet-layer, .leaflet-control { filter: invert(1) hue-rotate(180deg) brightness(1.1); }

        .bar-wrap { background: #111; height: 10px; border: 1px solid #333; margin: 6px 0; border-radius: 2px; overflow: hidden; }
        .bar-fill { height: 100%; background: var(--neon); width: 0%; transition: width 0.6s ease; }
        .bar-fill.high { background: var(--alert); }

        .btn-scan {
            width: 100%; padding: 12px; background: transparent;
            border: 2px solid var(--neon); color: var(--neon);
            font-family: inherit; font-size: 1rem; cursor: pointer;
            transition: all 0.3s;
        }
        .btn-scan:hover { background: var(--neon); color: #000; }
        .btn-scan:disabled { opacity: 0.4; cursor: not-allowed; }

        .btn-kill {
            background: transparent; border: 1px solid var(--alert);
            color: var(--alert); padding: 2px 8px; font-size: 0.7rem;
            cursor: pointer; font-family: inherit;
        }
        .btn-kill:hover { background: var(--alert); color: #000; }

        table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        th { background: rgba(0,255,65,0.1); padding: 6px; text-align: left; position: sticky; top: 0; z-index: 10; }
        td { padding: 5px 6px; border-bottom: 1px solid #111; }
        tr:hover { background: rgba(0,255,65,0.08); }

        .log-container {
            flex: 1; overflow-y: auto; padding: 8px; background: #000; font-size: 0.78rem;
            scrollbar-width: thin; scrollbar-color: var(--dim) transparent;
        }
        .log-entry {
            margin-bottom: 4px; padding-left: 8px; border-left: 3px solid transparent;
            word-break: break-all; line-height: 1.3;
        }
        .log-alert { border-left-color: var(--alert); color: var(--alert); }
        .log-info { border-left-color: var(--neon); color: #aaa; }
        .log-warn { border-left-color: var(--warn); color: var(--warn); }

        .hp-hit { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body>

<div class="grid-container">

    <header>
        <div class="brand">NETWATCH <span style="color:var(--warn)">ULTIMATE</span><span class="blink">_</span></div>
        <div>
            <span id="hp-status">[ HONEYPOT: ARMED ]</span> • 
            DATA: <span id="total-gb">0.00</span> GB • 
            <span id="sys-clock">00:00:00</span>
        </div>
    </header>

    <aside class="panel" style="grid-row: 2 / 4;">
        <div class="panel-head">GEOINT TRACKER</div>
        <div id="map"></div>

        <div class="panel-head">SYSTEM VITALS</div>
        <div style="padding:10px;">
            <div>CPU <span id="val-cpu" style="float:right">0%</span></div>
            <div class="bar-wrap"><div id="bar-cpu" class="bar-fill"></div></div>

            <div>RAM <span id="val-ram" style="float:right">0%</span></div>
            <div class="bar-wrap"><div id="bar-ram" class="bar-fill"></div></div>

            <div>BATTERY <span id="val-bat" style="float:right">0%</span></div>
            <div class="bar-wrap"><div id="bar-bat" class="bar-fill"></div></div>
        </div>

        <div class="panel-head">LAN RADAR CONTROL</div>
        <div style="padding:10px;">
            <button id="scan-btn" class="btn-scan">INITIATE LAN RADAR SCAN</button>
        </div>
    </aside>

    
    <main class="panel" style="grid-column:2; grid-row:2/4;">
        <div class="panel-head">
            ACTIVE OUTBOUND LINKS
            <span style="color:#888; font-size:0.8em" id="conn-count">0 ACTIVE</span>
        </div>
        <div style="flex:1; overflow:auto;">
            <table id="conn-table">
                <thead>
                    <tr>
                        <th>APP</th>
                        <th>PID</th>
                        <th>TARGET</th>
                        <th>GEO</th>
                        <th>PROTO</th>
                        <th>LATENCY</th>
                        <th>ACTION</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </main>

    <aside class="panel" style="grid-column:3; grid-row:2;">
        <div class="panel-head">LAN RADAR RESULTS</div>
        <div style="flex:1; overflow:auto;">
            <table id="lan-table">
                <thead><tr><th>IP ADDRESS</th><th>MAC ADDRESS</th></tr></thead>
                <tbody>
                    <tr><td colspan="2" style="text-align:center; color:#555">Awaiting scan...</td></tr>
                </tbody>
            </table>
        </div>
    </aside>

   
    <aside class="panel" style="grid-column:3; grid-row:3;">
        <div class="panel-head">INTERCEPT LOG & ALERTS</div>
        <div id="sys-log" class="log-container"></div>
    </aside>

</div>

<script>
    const socket = io();
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'NETWATCH GEOINT'
    }).addTo(map);

    let markers = {};
    const sysLog = document.getElementById('sys-log');
    const connTbody = document.querySelector('#conn-table tbody');
    const lanTbody = document.querySelector('#lan-table tbody');
    const scanBtn = document.getElementById('scan-btn');

    function log(msg, type = 'info') {
        const div = document.createElement('div');
        div.className = `log-entry log-${type}`;
        const t = new Date().toLocaleTimeString('en-GB', {hour12: false});
        div.innerHTML = `<span style="color:#555">[${t}]</span> ${msg}`;
        sysLog.prepend(div);
        if (sysLog.children.length > 100) sysLog.removeChild(sysLog.lastChild);
    }

    function updateBar(id, val) {
        const bar = document.getElementById('bar-' + id);
        document.getElementById('val-' + id).textContent = val + '%';
        bar.style.width = val + '%';
        bar.classList.toggle('high', val > 85);
    }

    
    scanBtn.onclick = () => {
        if (scanBtn.disabled) return;
        scanBtn.disabled = true;
        scanBtn.textContent = "SCANNING LAN...";
        socket.emit('scan_lan');
    };

    function killPid(pid) {
        if (confirm(`TERMINATE PID ${pid}?`)) {
            socket.emit('kill_process', { pid });
        }
    }

    
    socket.on('connect', () => log('NETWATCH ONLINE', 'info'));

    socket.on('alert', data => {
        log(data.message, data.type === 'danger' ? 'alert' : data.type || 'info');

        if (data.type === 'success' && data.message.includes('Found')) {
            scanBtn.disabled = false;
            scanBtn.textContent = "INITIATE LAN RADAR SCAN";
        }
        if (data.message.includes('already in progress')) {
            scanBtn.disabled = true;
            scanBtn.textContent = "SCAN IN PROGRESS...";
        }
    });

    socket.on('lan_update', devices => {
        if (!devices || devices.length === 0) {
            lanTbody.innerHTML = `<tr><td colspan="2" style="text-align:center; color:#666">NO DEVICES DETECTED</td></tr>`;
            return;
        }
        lanTbody.innerHTML = devices.map(d => 
            `<tr><td style="color:#0f0">${d.ip}</td><td style="font-size:0.75rem; color:#0b0">${d.mac}</td></tr>`
        ).join('');
    });

    socket.on('update', data => {
        
        document.getElementById('sys-clock').textContent = data.timestamp;
        document.getElementById('total-gb').textContent = data.total_data_gb.toFixed(2);
        document.getElementById('conn-count').textContent = data.connections.length + " ACTIVE";

       
        if (data.honey_pot_hits > 0) {
            document.getElementById('hp-status').innerHTML = 
                `[ HONEYPOT: <span class="hp-hit" style="color:var(--alert)">${data.honey_pot_hits} HIT${data.honey_pot_hits > 1 ? 'S' : ''}</span> ]`;
        }

        
        updateBar('cpu', Math.round(data.vitals.cpu));
        updateBar('ram', Math.round(data.vitals.ram));
        updateBar('bat', data.vitals.battery);

        // Connections + Map
        const newMarkers = {};
        connTbody.innerHTML = data.connections.map(c => {
            if (c.loc && c.loc !== "0,0") {
                const [lat, lng] = c.loc.split(',');
                const key = c.remote_ip;
                if (!markers[key]) {
                    newMarkers[key] = L.circleMarker([lat, lng], {
                        radius: 5, color: '#f33', fillOpacity: 0.9, weight: 2
                    }).addTo(map).bindPopup(`<b>${c.remote_ip}</b><br>${c.country}<br>${c.org}`);
                } else {
                    newMarkers[key] = markers[key];
                }
            }

            const latColor = c.latency_ms > 200 ? 'var(--alert)' : c.latency_ms > 80 ? 'var(--warn)' : 'var(--neon)';
            return `
                <tr>
                    <td style="color:#0f0">${c.app_name}</td>
                    <td style="color:#666; font-size:0.75rem">${c.pid || '-'}</td>
                    <td>${c.remote_address}<br><small style="color:#555">${c.org.slice(0,20)}</small></td>
                    <td>${c.country}</td>
                    <td>${c.protocol}</td>
                    <td style="color:${latColor}">${c.latency_ms}ms</td>
                    <td>${c.pid ? `<button class="btn-kill" onclick="killPid(${c.pid})">KILL</button>` : ''}</td>
                </tr>`;
        }).join('');

        // Clean old markers
        Object.keys(markers).forEach(ip => {
            if (!newMarkers[ip]) map.removeLayer(markers[ip]);
        });
        markers = newMarkers;

        // Log new packets
        data.packets.forEach(p => {
            const preview = p.payload_preview || '';
            const cardAlert = preview.includes('card') || preview.match(/\d{13,19}/) ? '[CARD DETECTED] ' : '';
            log(`${cardAlert}${p.proto} ${p.src} → ${p.dst} ${preview}`, cardAlert ? 'alert' : 'info');
        });
    });

    // Re-enable scan button on any error or completion
    socket.on('disconnect', () => {
        log('NETWATCH OFFLINE', 'alert');
        scanBtn.disabled = false;
        scanBtn.textContent = "INITIATE LAN RADAR SCAN";
    });
</script>

</body>
</html>
